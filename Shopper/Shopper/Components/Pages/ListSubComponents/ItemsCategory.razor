@using Shopper.Core.Components.Dtos
@using Shopper.Core.Components.Enums
@using Shopper.Services.Components.Dtos
@using Shopper.Services.Components.State

@if (Enum.TryParse<ItemCategory>(SelectedList, out var category))
{
    switch (category)
    {
        case ItemCategory.MainList:
            <CategoryList Items="Items.Where(g => !g.InCart).SelectMany(g => g.Items)"
                          SubmitItem="SubmitItem"
                          RemoveItem="RemoveItem" />
            break;

        case ItemCategory.Cart:
            <CategoryList Items="Items.Where(g => g.InCart).SelectMany(g => g.Items)"
                          MoveItemFromCart="MoveItemFromCart"
                          RemoveItem="RemoveItem" />
            break;

        default:
            @if (categoryData.ContainsKey(category))
            {
                <CategoryList Items="categoryData[category]"
                              SubmitItem="SubmitItem"
                              RemoveItem="RemoveItem" />
            }
            break;
    }
}
@code {
    [Parameter] public string SelectedList { get; set; } = "MainList";
    [Parameter] public List<ItemGroupDto> Items { get; set; } = new();

    [Parameter] public EventCallback<ItemDto> SubmitItem { get; set; }
    [Parameter] public EventCallback<ItemDto> MoveItemFromCart { get; set; }
    [Parameter] public EventCallback<ItemDto> RemoveItem { get; set; }


    private Dictionary<ItemCategory, List<ItemDto>> categoryData => Items
        .SelectMany(g => g.Items ?? Enumerable.Empty<ItemDto>())
        .Where(item => !string.IsNullOrWhiteSpace(item.Genre))
        .Select(item => (Item: item, Parsed: TryParseCategory(item.Genre)))
        .Where(t => t.Parsed.HasValue && t.Parsed.Value != ItemCategory.MainList && t.Parsed.Value != ItemCategory.Cart)
        .GroupBy(t => t.Parsed.Value)
        .ToDictionary(
            g => g.Key,
            g => g
                .Select(t => t.Item)
                .Where(i => i != null) // defensive
                .Distinct()            // optional: requires ItemDto equality defined
                .ToList()
        );
    private static ItemCategory? TryParseCategory(string genre)
    {
        return Enum.TryParse<ItemCategory>(genre, true, out var cat) ? cat : null;
    }
}
