@page "/shopping-list"

@using Shopper.Components.Pages.ListSubComponents
@using Shopper.Core.Components.Dtos
@using Shopper.Core.Components.Enums
@using Shopper.Services.Components.Dtos
@using Shopper.Services.Components.State
@inject IItemsService itemsService

<h1>SelectedList</h1>
<div>
    <h2>Choose a list:</h2>
<div>
    @foreach (var category in categories)
    {
        <label>
            <input type="radio"
                   name="listSelection"
                   value="@category.Value"
                   checked="@IsSelected(category.Value)"
                   @onchange="OnSelectionChanged" />
            @category.Label
        </label>
    }
</div>
</div>

<ItemsCategory SelectedList="@selectedList" Items="@items" SubmitItem="@SubmitItem" MoveItemFromCart="@MoveItemFromCart" RemoveItem="@RemoveItem" />

@code {
    protected string selectedList = "MainList";
    protected List<ItemGroupDto> items = new();

    protected override async Task OnInitializedAsync()
    {
        selectedList = itemsService.GetSelectedList();
        itemsService.OnItemsChanged += HandleItemsChanged;
        items = await itemsService.RefreshItemsAsync();
    }

    private void HandleItemsChanged()
    {
        items = itemsService.GetCachedItems();
        InvokeAsync(StateHasChanged);
    }

    private async Task SubmitItem(ItemDto item)
    {
        await itemsService.MoveToCartAsync(item);
    }

    private async Task RemoveItem(ItemDto item)
    {
        await itemsService.RemoveItemAsync(item);
    }

    private async Task MoveItemFromCart(ItemDto item)
    {
        await itemsService.MoveToCartAsync(item);
    }

    public void Dispose()
    {
        itemsService.OnItemsChanged -= HandleItemsChanged;
    }

    private bool IsSelected(string value) => selectedList == value;

    private void OnSelectionChanged(ChangeEventArgs e)
    {
        selectedList = e.Value?.ToString() ?? "MainList";
        itemsService.SetSelectedList(selectedList);
    }

    private readonly List<(string Value, string Label)> categories = new()
    {
        ("MainList", "Aktualna lista"),
        ("Dairy", "Nabial"),
        ("Meat", "Mieso"),
        ("Wheat", "Zboze"),
        ("Fruit", "Owoce"),
        ("Vegetables", "Warzywa"),
        ("Beverages", "Napoje"),
        ("Cart", "Koszyk")
    };

}
